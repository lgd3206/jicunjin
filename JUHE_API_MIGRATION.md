# 聚合数据API迁移指南

## 📋 迁移概述

本项目已从极速数据API迁移到聚合数据API，以获取更稳定的黄金价格数据。

### 迁移时间
- 2026-02-10

### 主要变更
- API提供商：极速数据 → 聚合数据
- 环境变量：`JISUAPI_KEY` → `JUHE_API_KEY`
- 数据源：6个 → 2个（更专注核心数据）

---

## 🔄 数据源对比

### 保留的数据源 ✅

| 数据源 | 说明 | 数据内容 |
|--------|------|----------|
| 上海黄金交易所 | 国内权威金价 | Au99.99、Au(T+D)、Ag(T+D)等16个品种 |
| 上海期货交易所 | 期货市场价格 | 黄金期货主力合约及各月合约 |

### 移除的数据源 ❌

| 数据源 | 原因 |
|--------|------|
| 工商银行账户金 | 聚合数据API不提供 |
| 伦敦金 | 聚合数据API不提供 |
| 香港金 | 聚合数据API不提供 |
| 金店金价 | 聚合数据API不提供 |

**说明**：虽然数据源减少，但保留的都是最核心、最权威的数据源。Au99.99和Au(T+D)已经能够满足大部分投资决策需求。

---

## 🚀 快速开始

### 1. 获取聚合数据API密钥

1. 访问 [聚合数据官网](https://www.juhe.cn/)
2. 注册并登录账号
3. 搜索"黄金数据"API（ID: 29）
4. 点击"免费申请"
5. 在"我的API"中查看密钥

**免费额度**：50次/天（足够使用，当前每天调用48次）

### 2. 配置GitHub Secrets

1. 访问你的GitHub仓库：https://github.com/lgd3206/jicunjin
2. 进入 **Settings** → **Secrets and variables** → **Actions**
3. 点击 **New repository secret**
4. 添加以下配置：
   - **Name**: `JUHE_API_KEY`
   - **Value**: 你的聚合数据API密钥

### 3. 删除旧的Secret（可选）

如果不再使用极速数据API，可以删除：
- `JISUAPI_KEY`

### 4. 测试运行

1. 进入仓库的 **Actions** 标签页
2. 选择 **积存金价格监控** 工作流
3. 点击 **Run workflow** → **Run workflow**
4. 等待运行完成（约1-2分钟）

### 5. 验证结果

查看运行日志，应该看到：

```
============================================================
使用聚合数据API获取金价数据...
============================================================
✓ 上海黄金交易所: 获取 16 个品种
✓ 上海期货交易所: 获取 X 个黄金合约
✓ 成功提取Au99.99数据: Au99.99 = XXX.XX 元/克
✓ 成功提取Au(T+D)数据: Au(T+D) = XXX.XX 元/克
✓ 成功提取期货主力数据: 黄金XXXX = XXX.XX 元/克
数据获取完成: 2/2 个数据源成功
```

---

## 📧 邮件内容变化

### 新的邮件结构

1. **📊 价格概览**
   - 当前金价
   - 24小时最高价
   - 24小时最低价
   - 价格波动幅度

2. **🏛️ 上海黄金交易所**
   - **Au99.99**
     - 最新价、涨跌幅
     - 开盘价、最高价、最低价
     - 成交量、更新时间
   - **Au(T+D) 黄金延期**
     - 最新价、涨跌幅
     - 开盘价、最高价、最低价
     - 成交量、更新时间

3. **📈 上海期货交易所 - 沪金主力合约**
   - 合约名称（如"黄金2406"）
   - 最新价、涨跌幅
   - 开盘价、最高价、最低价
   - 成交量、更新时间

4. **⚠️ 触发原因**
   - 为什么发送这封提醒

5. **💡 投资建议**
   - 基于价格分析的建议

### 与旧版本的区别

| 项目 | 旧版本 | 新版本 |
|------|--------|--------|
| 数据源数量 | 6个 | 2个 |
| 核心数据 | ✅ | ✅ |
| 银行账户金 | ✅ | ❌ |
| 国际金价 | ✅ | ❌ |
| 邮件大小 | 较大 | 精简 |
| 加载速度 | 较慢 | 更快 |

---

## 🔧 技术细节

### API接口信息

**基础URL**: `http://web.juhe.cn/finance/gold`

**接口列表**:

1. **上海黄金交易所**
   - 端点: `/shgold`
   - 参数: `key` (必填)
   - 返回: 16个黄金品种数据

2. **上海期货交易所**
   - 端点: `/shfutures`
   - 参数: `key` (必填)
   - 返回: 黄金和白银期货合约数据（自动过滤白银）

### 数据字段映射

#### 上海黄金交易所字段

| 字段名 | 说明 | 示例 |
|--------|------|------|
| variety | 品种名称 | "Au99.99" |
| latestpri | 最新价 | "1120.00" |
| openpri | 开盘价 | "1118.50" |
| maxpri | 最高价 | "1122.00" |
| minpri | 最低价 | "1117.00" |
| limit | 涨跌幅 | "+0.15%" |
| yespri | 昨收价 | "1118.32" |
| totalvol | 成交量 | "12345.0000" |
| time | 更新时间 | "2026-02-10 15:30:00" |

#### 上海期货交易所字段

| 字段名 | 说明 | 示例 |
|--------|------|------|
| name | 合约名称 | "黄金2406" |
| latestpri | 最新价 | "520.50" |
| open | 开盘价 | "518.00" |
| maxpri | 最高价 | "521.00" |
| minpri | 最低价 | "517.50" |
| change | 涨跌 | "+2.50" |
| lastclear | 昨结算 | "518.00" |
| tradvol | 成交量 | "12345" |
| position | 持仓量 | "45678" |
| time | 更新时间 | "2026-02-10 15:30:00" |

### 代码变更

**新增文件**:
- `api/juhe_gold_api.py` - 聚合数据API封装

**修改文件**:
- `run_once.py` - 使用新API
- `notifications/enhanced_email_notifier.py` - 适配新数据格式
- `.github/workflows/gold-monitor.yml` - 环境变量更新
- `config/config_loader.py` - 支持新配置项
- `.env.example` - 添加API配置说明

---

## 📊 API使用统计

### 调用频率

- **定时任务**: 每30分钟运行一次
- **每天调用**: 48次
- **免费额度**: 50次/天
- **剩余额度**: 2次/天（缓冲）

### 数据更新频率

- **上海黄金交易所**: 每2分钟更新
- **上海期货交易所**: 每2分钟更新

### 成本分析

| 项目 | 免费版 | 黑钻会员 |
|------|--------|----------|
| 价格 | ¥0/天 | ¥3.56/天 |
| 调用次数 | 50次/天 | 10000次/天 |
| 当前需求 | 48次/天 | - |
| 是否够用 | ✅ 是 | - |

**结论**: 免费版完全够用，无需升级。

---

## 🐛 故障排查

### 问题1: GitHub Actions运行失败

**症状**: Actions日志显示"使用备用数据源"

**原因**: `JUHE_API_KEY` 未配置或配置错误

**解决方案**:
1. 检查GitHub Secrets中是否有 `JUHE_API_KEY`
2. 确认密钥是否正确（登录聚合数据网站查看）
3. 重新运行工作流

### 问题2: 期货数据获取失败

**症状**: 日志显示"上海期货交易所: 数据获取失败"

**原因**:
- API接口返回404
- 或者返回的数据中没有黄金期货

**解决方案**:
- 系统会自动跳过期货数据
- 只使用上海黄金交易所数据
- 不影响核心功能

### 问题3: 邮件中没有数据

**症状**: 收到邮件但内容为空

**原因**: 数据提取失败

**解决方案**:
1. 查看GitHub Actions日志
2. 确认API返回数据格式是否正确
3. 检查 `api/juhe_gold_api.py` 中的字段映射

### 问题4: API调用次数超限

**症状**: 日志显示"请求超过次数限制"

**原因**: 超过免费额度50次/天

**解决方案**:
1. 检查是否有其他程序在调用API
2. 考虑升级到黑钻会员（¥3.56/天）
3. 或者降低调用频率（改为每小时一次）

---

## 🔐 安全建议

### 保护API密钥

1. **不要**将API密钥提交到Git仓库
2. **不要**在代码中硬编码API密钥
3. **使用**GitHub Secrets存储敏感信息
4. **定期**更换API密钥

### .env文件安全

`.env` 文件已添加到 `.gitignore`，确保不会被提交到版本控制。

### API密钥泄露处理

如果API密钥泄露：
1. 立即登录聚合数据网站
2. 重新生成新的API密钥
3. 更新GitHub Secrets
4. 删除旧密钥

---

## 📞 支持与反馈

### 聚合数据官方支持

- **官网**: https://www.juhe.cn/
- **客服电话**: 0512-88869195
- **在线客服**: 网站右下角聊天窗口

### 项目问题反馈

如果遇到问题，请：
1. 查看GitHub Actions运行日志
2. 检查本文档的故障排查部分
3. 在GitHub仓库提交Issue

---

## 📝 更新日志

### 2026-02-10 - v2.0.0

**重大变更**:
- ✅ 迁移到聚合数据API
- ✅ 简化数据源（6个→2个）
- ✅ 优化邮件模板
- ✅ 修复期货接口字段映射
- ✅ 添加黄金期货过滤

**新增功能**:
- ✅ 支持Au(T+D)黄金延期数据
- ✅ 支持期货合约详细信息
- ✅ 自动过滤白银期货

**移除功能**:
- ❌ 工商银行账户金
- ❌ 伦敦金
- ❌ 香港金
- ❌ 金店金价

---

## 🎯 未来计划

### 短期计划（1-2周）

- [ ] 监控API稳定性
- [ ] 收集用户反馈
- [ ] 优化邮件模板

### 中期计划（1-3个月）

- [ ] 考虑添加更多数据源（如需要）
- [ ] 优化价格分析算法
- [ ] 添加价格预测功能

### 长期计划（3-6个月）

- [ ] 开发Web界面
- [ ] 添加微信通知
- [ ] 支持多种贵金属监控

---

## ✅ 迁移检查清单

完成以下步骤确保迁移成功：

- [ ] 获取聚合数据API密钥
- [ ] 配置GitHub Secrets (`JUHE_API_KEY`)
- [ ] 删除旧的Secret (`JISUAPI_KEY`)
- [ ] 手动触发GitHub Actions测试
- [ ] 验证运行日志无错误
- [ ] 检查邮件内容是否正确
- [ ] 确认数据源显示完整
- [ ] 监控API调用次数

---

## 📚 相关文档

- [README.md](README.md) - 项目说明
- [.env.example](.env.example) - 配置示例
- [VERIFICATION_GUIDE.md](VERIFICATION_GUIDE.md) - 验证指南

---

**最后更新**: 2026-02-10
**文档版本**: 1.0.0
**维护者**: Claude Sonnet 4.5
